name: Build
description: Build a Docker image for one platform

inputs:
  platform:
    description: Platform this build is for (e.g. arm64 or amd64)
    required: true
    type: string
  github_token:
    description: GitHub token to use for authenticating with ghcr.io
    required: true
    type: string
outputs:
  service-digest:
    description: Digest of the generated staking-ui-service Docker image
    value: ${{ steps.build-service.outputs.digest }}
  client-swarm-digest:
    description: Digest of the generated staking-client-swarm Docker image
    value: ${{ steps.build-client-swarm.outputs.digest }}

runs:
  using: 'composite'
  steps:
    - uses: rui314/setup-mold@v1
    - uses: extractions/setup-just@v3

    - uses: Swatinem/rust-cache@v2
      with:
        save-if: ${{ github.ref == 'refs/heads/main'  }}
        shared-key: build-${{ inputs.platform }}

    - name: Cargo Build
      shell: bash
      run: just build release --features rand

    - name: Setup Docker BuildKit (buildx)
      uses: docker/setup-buildx-action@v3

    - name: Login to Github Container Repo
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ inputs.github_token }}

    - uses: docker/metadata-action@v5
      name: Generate staking-ui-service Docker Metadata
      id: service-metadata
      with:
        images: ghcr.io/espressosystems/staking-ui-service
        flavor: |
          latest=true
          suffix=-${{ inputs.platform }},onlatest=true

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      id: build-service
      with:
        context: .
        file: docker/staking-ui-service.Dockerfile
        labels: ${{ steps.service-metadata.outputs.labels }}
        tags: ${{ steps.service-metadata.outputs.tags }}
        platforms: linux/${{ inputs.platform }}
        push: ${{ github.event_name != 'pull_request' }}
    

    - uses: docker/metadata-action@v5
      name: Generate client-swarm Docker Metadata
      id: client-swarm-metadata
      with:
        images: ghcr.io/espressosystems/staking-ui-service
        flavor: |
          latest=true
          suffix=-${{ inputs.platform }},onlatest=true

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      id: build-client-swarm
      with:
        context: .
        file: docker/client-swarm.Dockerfile
        labels: ${{ steps.client-swarm-metadata.outputs.labels }}
        tags: ${{ steps.client-swarm-metadata.outputs.tags }}
        platforms: linux/${{ inputs.platform }}
        push: ${{ github.event_name != 'pull_request' }}
