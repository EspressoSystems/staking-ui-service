name: Build
description: Build a Docker image for one platform

inputs:
  platform:
    description: Platform this build is for (e.g. arm64 or amd64)
    required: true
    type: string
  github_token:
    description: GitHub token to use for authenticating with ghcr.io
    required: true
    type: string
outputs:
  digest:
    description: Digest of the generated Docker image
    value: ${{ steps.build.outputs.digest }}

runs:
  using: 'composite'
  steps:
    - uses: rui314/setup-mold@v1
    - uses: extractions/setup-just@v3

    - uses: Swatinem/rust-cache@v2
      with:
        save-if: ${{ github.ref == 'refs/heads/main'  }}
        shared-key: build-${{ inputs.platform }}

    - name: Cargo Build
      shell: bash
      run: just build release

    - name: Setup Docker BuildKit (buildx)
      uses: docker/setup-buildx-action@v3

    - name: Login to Github Container Repo
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ inputs.github_token }}

    - uses: docker/metadata-action@v5
      name: Generate Docker Metadata
      id: metadata
      with:
        images: ghcr.io/espressosystems/staking-ui-service
        flavor: |
          latest=true
          suffix=-${{ inputs.platform }},onlatest=true

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      id: build
      with:
        context: .
        file: Dockerfile
        labels: ${{ steps.metadata.outputs.labels }}
        tags: ${{ steps.metadata.outputs.tags }}
        platforms: linux/${{ inputs.platform }}
        push: ${{ github.event_name != 'pull_request' }}
